<mxfile host="app.diagrams.net" modified="2026-02-25T00:00:00.000Z" agent="Copilot" version="24.0.0" type="device">
  <diagram id="sql-monitoring-architecture" name="SQL Server Monitoring - Architecture">
    <mxGraphModel dx="1422" dy="762" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="900" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="&lt;b&gt;SQL Server Monitoring Solution - Architecture&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=20;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="450" y="20" width="500" height="40" as="geometry" />
        </mxCell>

        <!-- On-Premises / IaaS Zone -->
        <mxCell id="onprem-zone" value="&lt;b&gt;On-Premises / IaaS VMs&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1565C0;dashed=1;dashPattern=5 5;verticalAlign=top;fontStyle=1;fontSize=13;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="40" y="90" width="320" height="470" as="geometry" />
        </mxCell>

        <!-- SQL Server 1 -->
        <mxCell id="sql1" value="&lt;b&gt;SQL Server 1&lt;/b&gt;&lt;br&gt;Instance: SQLVM01&lt;br&gt;Port 1433" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/databases/SQL_Server.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="150" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- SQL Server 2 -->
        <mxCell id="sql2" value="&lt;b&gt;SQL Server 2&lt;/b&gt;&lt;br&gt;Instance: SQLVM02&lt;br&gt;Port 1433" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/databases/SQL_Server.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="290" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- SQL Server N -->
        <mxCell id="sqlN" value="&lt;b&gt;SQL Server N&lt;/b&gt;&lt;br&gt;Instance: SQLVM-N&lt;br&gt;Port 1433" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/databases/SQL_Server.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="420" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- Azure Arc Zone -->
        <mxCell id="arc-zone" value="&lt;b&gt;Azure Arc-enabled Server&lt;/b&gt;&lt;br&gt;(Hybrid Worker)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF3E0;strokeColor=#E65100;dashed=1;dashPattern=5 5;verticalAlign=top;fontStyle=1;fontSize=13;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="440" y="90" width="300" height="470" as="geometry" />
        </mxCell>

        <!-- Arc VM -->
        <mxCell id="arcvm" value="&lt;b&gt;Arc-enabled VM&lt;/b&gt;&lt;br&gt;Azure Connected Machine Agent&lt;br&gt;Managed Identity" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/management_governance/Arc_Machines.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="550" y="140" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- Hybrid Worker Extension -->
        <mxCell id="hwext" value="&lt;b&gt;Hybrid Worker&lt;/b&gt;&lt;br&gt;&lt;b&gt;Extension&lt;/b&gt;&lt;br&gt;Runs PowerShell 7.2&lt;br&gt;runbooks locally" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=11;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="500" y="260" width="170" height="80" as="geometry" />
        </mxCell>

        <!-- Runbook -->
        <mxCell id="runbook" value="&lt;b&gt;PowerShell Runbook&lt;/b&gt;&lt;br&gt;Get-SQLServerInfo-&lt;br&gt;LogsIngestionApi.ps1&lt;br&gt;&lt;i&gt;Collects metrics per DB&lt;/i&gt;" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;size=15;fillColor=#FFF9C4;strokeColor=#F9A825;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="500" y="380" width="170" height="90" as="geometry" />
        </mxCell>

        <!-- Azure Cloud Zone -->
        <mxCell id="azure-zone" value="&lt;b&gt;Azure Cloud&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#2E7D32;dashed=1;dashPattern=5 5;verticalAlign=top;fontStyle=1;fontSize=13;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="820" y="90" width="380" height="710" as="geometry" />
        </mxCell>

        <!-- Automation Account -->
        <mxCell id="autoAccount" value="&lt;b&gt;Azure Automation&lt;/b&gt;&lt;br&gt;Account&lt;br&gt;&lt;i&gt;Schedule + Runbook&lt;/i&gt;" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/management_governance/Automation_Accounts.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="870" y="140" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- Key Vault -->
        <mxCell id="keyvault" value="&lt;b&gt;Azure Key Vault&lt;/b&gt;&lt;br&gt;&lt;i&gt;SQL Credentials&lt;/i&gt;&lt;br&gt;(optional for SQL Auth)" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/security/Key_Vaults.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1070" y="140" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- DCE -->
        <mxCell id="dce" value="&lt;b&gt;Data Collection&lt;/b&gt;&lt;br&gt;&lt;b&gt;Endpoint (DCE)&lt;/b&gt;&lt;br&gt;&lt;i&gt;Logs Ingestion API&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=11;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="850" y="310" width="160" height="70" as="geometry" />
        </mxCell>

        <!-- DCR -->
        <mxCell id="dcr" value="&lt;b&gt;Data Collection&lt;/b&gt;&lt;br&gt;&lt;b&gt;Rule (DCR)&lt;/b&gt;&lt;br&gt;&lt;i&gt;Stream: Custom-&lt;br&gt;SQLServerMonitoring_CL&lt;/i&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=11;fontStyle=0;" vertex="1" parent="1">
          <mxGeometry x="850" y="420" width="160" height="80" as="geometry" />
        </mxCell>

        <!-- Log Analytics -->
        <mxCell id="law" value="&lt;b&gt;Log Analytics&lt;/b&gt;&lt;br&gt;&lt;b&gt;Workspace&lt;/b&gt;&lt;br&gt;&lt;i&gt;Custom Table:&lt;br&gt;SQLServerMonitoring_CL&lt;/i&gt;&lt;br&gt;(20 columns)" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/analytics/Log_Analytics_Workspaces.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="900" y="560" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- Azure Monitor Workbook -->
        <mxCell id="workbook" value="&lt;b&gt;Azure Monitor&lt;/b&gt;&lt;br&gt;&lt;b&gt;Workbook&lt;/b&gt;&lt;br&gt;&lt;i&gt;4 Tabs: Summary,&lt;br&gt;Instances, Databases,&lt;br&gt;Backups&lt;/i&gt;" style="shape=image;verticalLabelPosition=bottom;labelBackgroundColor=default;verticalAlign=top;aspect=fixed;imageAspect=0;image=img/lib/azure2/management_governance/Monitor.svg;html=1;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1080" y="560" width="60" height="60" as="geometry" />
        </mxCell>

        <!-- Connections: SQL to Hybrid Worker -->
        <mxCell id="conn-sql1-hw" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#1565C0;strokeWidth=2;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" edge="1" source="sql1" target="hwext" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-sql1-label" value="&lt;i&gt;TCP 1433&lt;br&gt;Win/SQL Auth&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#1565C0;" vertex="1" connectable="0" parent="conn-sql1-hw">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="conn-sql2-hw" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#1565C0;strokeWidth=2;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" source="sql2" target="hwext" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="conn-sqlN-hw" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#1565C0;strokeWidth=2;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" edge="1" source="sqlN" target="hwext" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Arc VM to Automation Account -->
        <mxCell id="conn-arc-auto" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#E65100;strokeWidth=2;dashed=1;" edge="1" source="arcvm" target="autoAccount" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-arc-auto-label" value="&lt;i&gt;Hybrid Worker&lt;br&gt;Registration&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#E65100;" vertex="1" connectable="0" parent="conn-arc-auto">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Hybrid Worker to DCE -->
        <mxCell id="conn-hw-dce" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2E7D32;strokeWidth=2;" edge="1" source="runbook" target="dce" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-hw-dce-label" value="&lt;b&gt;Logs Ingestion API&lt;/b&gt;&lt;br&gt;&lt;i&gt;HTTPS POST&lt;br&gt;Managed Identity Token&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#2E7D32;" vertex="1" connectable="0" parent="conn-hw-dce">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- DCE to DCR -->
        <mxCell id="conn-dce-dcr" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2E7D32;strokeWidth=2;" edge="1" source="dce" target="dcr" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- DCR to Log Analytics -->
        <mxCell id="conn-dcr-law" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#2E7D32;strokeWidth=2;" edge="1" source="dcr" target="law" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-dcr-law-label" value="&lt;i&gt;Transform &amp;amp;&lt;br&gt;Ingest&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#2E7D32;" vertex="1" connectable="0" parent="conn-dcr-law">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Log Analytics to Workbook -->
        <mxCell id="conn-law-wb" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#6A1B9A;strokeWidth=2;" edge="1" source="law" target="workbook" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-law-wb-label" value="&lt;i&gt;KQL Queries&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#6A1B9A;" vertex="1" connectable="0" parent="conn-law-wb">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- HW to Key Vault -->
        <mxCell id="conn-hw-kv" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#F9A825;strokeWidth=1;dashed=1;dashPattern=5 5;" edge="1" source="hwext" target="keyvault" parent="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="750" y="300" />
              <mxPoint x="750" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="conn-hw-kv-label" value="&lt;i&gt;SQL Auth only:&lt;br&gt;Get Credentials&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#F9A825;" vertex="1" connectable="0" parent="conn-hw-kv">
          <mxGeometry x="-0.3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- HW Extension to Runbook -->
        <mxCell id="conn-hwext-rb" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#E65100;strokeWidth=1;" edge="1" source="hwext" target="runbook" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn-hwext-rb-label" value="&lt;i&gt;Executes&lt;/i&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#E65100;" vertex="1" connectable="0" parent="conn-hwext-rb">
          <mxGeometry x="-0.2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Arc VM to HW Extension -->
        <mxCell id="conn-arcvm-hwext" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#E65100;strokeWidth=1;" edge="1" source="arcvm" target="hwext" parent="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="&lt;b&gt;Legend&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;verticalAlign=top;fontStyle=1;fontSize=11;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="620" width="320" height="180" as="geometry" />
        </mxCell>
        <mxCell id="leg1" value="SQL Connection (TCP 1433)" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=#1565C0;fillColor=none;fontSize=10;fontColor=#1565C0;" vertex="1" parent="1">
          <mxGeometry x="60" y="650" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg2" value="Logs Ingestion API (HTTPS)" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=#2E7D32;fillColor=none;fontSize=10;fontColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="60" y="675" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg3" value="Hybrid Worker Control (HTTPS)" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=#E65100;fillColor=none;fontSize=10;fontColor=#E65100;" vertex="1" parent="1">
          <mxGeometry x="60" y="700" width="190" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg4" value="KQL Visualization" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=#6A1B9A;fillColor=none;fontSize=10;fontColor=#6A1B9A;" vertex="1" parent="1">
          <mxGeometry x="60" y="725" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="leg5" value="Key Vault (optional - SQL Auth only)" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=#F9A825;fillColor=none;fontSize=10;fontColor=#F9A825;" vertex="1" parent="1">
          <mxGeometry x="60" y="750" width="210" height="20" as="geometry" />
        </mxCell>

        <!-- Data Flow Numbers -->
        <mxCell id="step1" value="1" style="ellipse;whiteSpace=wrap;html=1;fillColor=#1565C0;strokeColor=#1565C0;fontColor=#FFFFFF;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="270" y="270" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="step2" value="2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#E65100;strokeColor=#E65100;fontColor=#FFFFFF;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="570" y="350" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="step3" value="3" style="ellipse;whiteSpace=wrap;html=1;fillColor=#2E7D32;strokeColor=#2E7D32;fontColor=#FFFFFF;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="790" y="380" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="step4" value="4" style="ellipse;whiteSpace=wrap;html=1;fillColor=#2E7D32;strokeColor=#2E7D32;fontColor=#FFFFFF;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="960" y="510" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="step5" value="5" style="ellipse;whiteSpace=wrap;html=1;fillColor=#6A1B9A;strokeColor=#6A1B9A;fontColor=#FFFFFF;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1020" y="600" width="30" height="30" as="geometry" />
        </mxCell>

        <!-- Step Labels -->
        <mxCell id="stepLabel" value="&lt;b&gt;Data Flow:&lt;/b&gt;&lt;br&gt;① SQL queries collect metrics&lt;br&gt;② Runbook processes data per DB&lt;br&gt;③ POST to Logs Ingestion API (via DCE)&lt;br&gt;④ DCR transforms &amp; routes to table&lt;br&gt;⑤ Workbook visualizes with KQL" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=11;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="440" y="620" width="280" height="100" as="geometry" />
        </mxCell>

        <!-- RBAC Box -->
        <mxCell id="rbac" value="&lt;b&gt;RBAC Permissions&lt;/b&gt;&lt;br&gt;• Monitoring Metrics Publisher → DCR&lt;br&gt;• Key Vault Secrets User → KV (SQL Auth)&lt;br&gt;• SQL Server login on target instances" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=#666666;fillColor=#FFF9C4;fontSize=10;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="440" y="730" width="280" height="70" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>