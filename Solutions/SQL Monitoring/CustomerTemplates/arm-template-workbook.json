{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "SQL Server Monitoring Solution - Azure Monitor Workbook. Deploys a shared workbook with 4 tabs: Summary, Instances, Databases, and Backups.",
    "author": "Azure Monitor Assets"
  },
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "SQL Server Monitoring Dashboard",
      "metadata": {
        "description": "Display name for the workbook in Azure Monitor."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for the workbook resource."
      }
    }
  },
  "variables": {
    "workbookId": "[guid(resourceGroup().id, parameters('workbookDisplayName'))]",
    "workbookContent": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# SQL Server Monitoring Dashboard\\n\\nThis workbook displays SQL Server monitoring data collected by the Azure Automation runbook via Logs Ingestion API.\\n\\n---\"},\"name\":\"header\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"1a2b3c4d-5e6f-7890-abcd-ef1234567890\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Subscription\",\"label\":\"Subscription\",\"type\":6,\"isRequired\":true,\"multiSelect\":false,\"query\":\"summarize by subscriptionId\\n| project value = strcat('/subscriptions/', subscriptionId), label = subscriptionId\",\"crossComponentResources\":[\"value::selected\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"includeAll\":false,\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"2b3c4d5e-6f7a-8901-bcde-f23456789012\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Workspace\",\"label\":\"Log Analytics Workspace\",\"type\":5,\"isRequired\":true,\"query\":\"resources\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\n| project id, name, location, resourceGroup\\n| order by name asc\",\"crossComponentResources\":[\"{Subscription}\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resourcegraph/resources\"},{\"id\":\"a2b3c4d5-e6f7-8901-2345-67890abcdef0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"value\":{\"durationMs\":86400000}},{\"id\":\"b3c4d5e6-f7a8-9012-3456-7890abcdef01\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SqlInstance\",\"label\":\"SQL Instance\",\"type\":2,\"isRequired\":false,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where isnotempty(SqlInstance)\\n| where SqlInstance !contains \\\",\\\" and not(SqlInstance startswith \\\"[\\\") and not(SqlInstance endswith \\\"]\\\")\\n| distinct SqlInstance\\n| order by SqlInstance asc\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"c4d5e6f7-a8b9-0123-4567-890abcdef012\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"DatabaseName\",\"label\":\"Database\",\"type\":2,\"isRequired\":false,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| distinct DatabaseName\\n| order by DatabaseName asc\",\"crossComponentResources\":[\"{Workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"tab-summary\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üìä Summary\",\"subTarget\":\"Summary\",\"style\":\"link\"},{\"id\":\"tab-instances\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üñ•Ô∏è Instances\",\"subTarget\":\"Instances\",\"style\":\"link\"},{\"id\":\"tab-databases\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üóÑÔ∏è Databases\",\"subTarget\":\"Databases\",\"style\":\"link\"},{\"id\":\"tab-backups\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"üíæ Backups\",\"subTarget\":\"Backups\",\"style\":\"link\"}]},\"name\":\"tabs\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Overview Metrics\"},\"name\":\"summary-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| summarize LastSeen = max(TimeGenerated) by SqlInstance\\n| count\",\"size\":4,\"title\":\"Total SQL Instances\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":true}},\"customWidth\":\"25\",\"name\":\"tile-instances\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| count\",\"size\":4,\"title\":\"Total Databases\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"green\"}},\"showBorder\":true}},\"customWidth\":\"25\",\"name\":\"tile-databases\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| where FullBackupAlertStatus in (\\\"Warning\\\", \\\"Critical\\\", \\\"Never\\\")\\n| count\",\"size\":4,\"title\":\"Backup Alerts\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"redBright\"}},\"showBorder\":true}},\"customWidth\":\"25\",\"name\":\"tile-backup-alerts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| summarize \\n    TotalDatabases = count(),\\n    CompliantDatabases = countif(HoursSinceFullBackup <= 24 and HoursSinceFullBackup >= 0)\\n| extend CompliancePercent = round(100.0 * CompliantDatabases / TotalDatabases, 1)\\n| project CompliancePercent\",\"size\":4,\"title\":\"Backup Compliance %\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"CompliancePercent\",\"formatter\":12,\"formatOptions\":{\"palette\":\"greenRed\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},\"showBorder\":true}},\"customWidth\":\"25\",\"name\":\"tile-compliance\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Backup Status by Alert Level\"},\"name\":\"backup-status-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| summarize Count = count() by FullBackupAlertStatus\\n| order by Count desc\",\"size\":3,\"title\":\"Databases by Backup Alert Status\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"OK\",\"color\":\"green\"},{\"seriesName\":\"Warning\",\"color\":\"yellow\"},{\"seriesName\":\"Critical\",\"color\":\"redBright\"},{\"seriesName\":\"Never\",\"color\":\"gray\"}]}},\"customWidth\":\"50\",\"name\":\"chart-backup-status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| summarize Count = count() by RecoveryModel\\n| order by Count desc\",\"size\":3,\"title\":\"Databases by Recovery Model\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"FULL\",\"color\":\"blue\"},{\"seriesName\":\"SIMPLE\",\"color\":\"orange\"},{\"seriesName\":\"BULK_LOGGED\",\"color\":\"purple\"}]}},\"customWidth\":\"50\",\"name\":\"chart-recovery-model\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Instance Uptime Overview\"},\"name\":\"uptime-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| summarize arg_max(TimeGenerated, *) by SqlInstance\\n| project SqlInstance, ServerName, SqlVersion, InstanceStartTime, InstanceUptimeDays, InstanceUptimeHours\\n| extend UptimeDisplay = strcat(InstanceUptimeDays, \\\"d \\\", InstanceUptimeHours % 24, \\\"h\\\")\\n| project SqlInstance, ServerName, SqlVersion, InstanceStartTime, UptimeDisplay, InstanceUptimeDays\\n| order by InstanceUptimeDays desc\",\"size\":0,\"title\":\"SQL Instance Uptime\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"InstanceUptimeDays\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}}],\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"ServerName\",\"label\":\"Server\"},{\"columnId\":\"SqlVersion\",\"label\":\"SQL Version\"},{\"columnId\":\"InstanceStartTime\",\"label\":\"Started At\"},{\"columnId\":\"UptimeDisplay\",\"label\":\"Uptime\"},{\"columnId\":\"InstanceUptimeDays\",\"label\":\"Days\"}]}},\"name\":\"grid-uptime\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Summary\"},\"name\":\"group-summary\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## SQL Server Instances\\n\\nDetailed view of all monitored SQL Server instances.\"},\"name\":\"instances-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| summarize \\n    LastSeen = max(TimeGenerated),\\n    DatabaseCount = dcount(DatabaseName),\\n    arg_max(TimeGenerated, SqlVersion, ServerName, InstanceStartTime, InstanceUptimeDays, InstanceUptimeHours)\\n    by SqlInstance\\n| extend Status = iff(LastSeen > ago(15m), \\\"üü¢ Online\\\", \\\"üî¥ Offline\\\")\\n| extend UptimeDisplay = strcat(InstanceUptimeDays, \\\"d \\\", InstanceUptimeHours % 24, \\\"h\\\")\\n| project Status, SqlInstance, ServerName, SqlVersion, DatabaseCount, InstanceStartTime, UptimeDisplay, LastSeen\\n| order by Status asc, SqlInstance asc\",\"size\":0,\"title\":\"SQL Server Instances\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DatabaseCount\",\"formatter\":4,\"formatOptions\":{\"palette\":\"blue\"}},{\"columnMatch\":\"LastSeen\",\"formatter\":6}],\"filter\":true,\"sortBy\":[{\"itemKey\":\"SqlInstance\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"Status\",\"label\":\"Status\"},{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"ServerName\",\"label\":\"Server\"},{\"columnId\":\"SqlVersion\",\"label\":\"SQL Version\"},{\"columnId\":\"DatabaseCount\",\"label\":\"Databases\"},{\"columnId\":\"InstanceStartTime\",\"label\":\"Started At\"},{\"columnId\":\"UptimeDisplay\",\"label\":\"Uptime\"},{\"columnId\":\"LastSeen\",\"label\":\"Last Seen\"}]}},\"name\":\"grid-instances\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Instance Uptime Trend\"},\"name\":\"trend-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| summarize InstanceUptimeDays = max(InstanceUptimeDays) by bin(TimeGenerated, 1h), SqlInstance\\n| order by TimeGenerated asc\",\"size\":0,\"title\":\"Instance Uptime Over Time (Days)\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"linechart\",\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"yAxis\":[\"InstanceUptimeDays\"],\"group\":\"SqlInstance\",\"showLegend\":true}},\"name\":\"chart-uptime-trend\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Instances\"},\"name\":\"group-instances\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Databases\\n\\nDetailed view of all monitored databases across SQL Server instances.\"},\"name\":\"databases-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let _db = dynamic([{DatabaseName}]);\\nSQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where array_length(_db) == 0 or '*' in (_db) or DatabaseName in (_db)\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| project SqlInstance, DatabaseName, DatabaseState, RecoveryModel, DatabaseCreateDate, LastFullBackupTime, HoursSinceFullBackup, FullBackupAlertStatus\\n| order by SqlInstance asc, DatabaseName asc\",\"size\":0,\"title\":\"Database Details\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"DatabaseState\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"ONLINE\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"redBright\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"RecoveryModel\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"FULL\",\"representation\":\"blue\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"SIMPLE\",\"representation\":\"orange\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"purple\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"HoursSinceFullBackup\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":168,\"palette\":\"greenRed\"}},{\"columnMatch\":\"FullBackupAlertStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"OK\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"critical\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Never\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"DatabaseName\",\"label\":\"Database\"},{\"columnId\":\"DatabaseState\",\"label\":\"State\"},{\"columnId\":\"RecoveryModel\",\"label\":\"Recovery Model\"},{\"columnId\":\"DatabaseCreateDate\",\"label\":\"Created\"},{\"columnId\":\"LastFullBackupTime\",\"label\":\"Last Full Backup\"},{\"columnId\":\"HoursSinceFullBackup\",\"label\":\"Hours Since Backup\"},{\"columnId\":\"FullBackupAlertStatus\",\"label\":\"Alert Status\"}]}},\"name\":\"grid-databases\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Databases by Instance\"},\"name\":\"db-by-instance-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| summarize DatabaseCount = count() by SqlInstance\\n| order by DatabaseCount desc\",\"size\":2,\"title\":\"Database Count by Instance\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"barchart\",\"chartSettings\":{\"xAxis\":\"SqlInstance\",\"yAxis\":[\"DatabaseCount\"],\"showLegend\":false}},\"name\":\"chart-db-by-instance\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Databases\"},\"name\":\"group-databases\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Backup Status\\n\\nMonitoring of backup compliance across all databases.\"},\"name\":\"backups-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let _db = dynamic([{DatabaseName}]);\\nSQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where array_length(_db) == 0 or '*' in (_db) or DatabaseName in (_db)\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| summarize \\n    TotalDatabases = count(),\\n    CompliantDatabases = countif(HoursSinceFullBackup <= 24 and HoursSinceFullBackup >= 0),\\n    WarningDatabases = countif(HoursSinceFullBackup > 24 and HoursSinceFullBackup <= 48),\\n    CriticalDatabases = countif(HoursSinceFullBackup > 48 or FullBackupAlertStatus == \\\"Never\\\")\\n    by SqlInstance\\n| extend CompliancePercent = round(100.0 * CompliantDatabases / TotalDatabases, 1)\\n| project SqlInstance, TotalDatabases, CompliantDatabases, WarningDatabases, CriticalDatabases, CompliancePercent\\n| order by CompliancePercent asc\",\"size\":0,\"title\":\"Backup Compliance by Instance\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"CompliantDatabases\",\"formatter\":8,\"formatOptions\":{\"palette\":\"green\"}},{\"columnMatch\":\"WarningDatabases\",\"formatter\":8,\"formatOptions\":{\"palette\":\"yellow\"}},{\"columnMatch\":\"CriticalDatabases\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redBright\"}},{\"columnMatch\":\"CompliancePercent\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":100,\"palette\":\"redGreen\"},\"numberFormat\":{\"unit\":1,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}}],\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"TotalDatabases\",\"label\":\"Total DBs\"},{\"columnId\":\"CompliantDatabases\",\"label\":\"Compliant (‚â§24h)\"},{\"columnId\":\"WarningDatabases\",\"label\":\"Warning (24-48h)\"},{\"columnId\":\"CriticalDatabases\",\"label\":\"Critical (>48h)\"},{\"columnId\":\"CompliancePercent\",\"label\":\"Compliance %\"}]}},\"name\":\"grid-backup-compliance\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Databases with Backup Alerts\"},\"name\":\"backup-alerts-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let _db = dynamic([{DatabaseName}]);\\nSQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where array_length(_db) == 0 or '*' in (_db) or DatabaseName in (_db)\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| where FullBackupAlertStatus in (\\\"Warning\\\", \\\"Critical\\\", \\\"Never\\\")\\n| project SqlInstance, DatabaseName, RecoveryModel, LastFullBackupTime, HoursSinceFullBackup, FullBackupAlertStatus, LastLogBackupTime, MinutesSinceLogBackup\\n| order by \\n    case(FullBackupAlertStatus == \\\"Critical\\\", 1, FullBackupAlertStatus == \\\"Never\\\", 2, FullBackupAlertStatus == \\\"Warning\\\", 3, 4) asc,\\n    HoursSinceFullBackup desc\",\"size\":0,\"title\":\"Databases Requiring Attention\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HoursSinceFullBackup\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":168,\"palette\":\"greenRed\"}},{\"columnMatch\":\"FullBackupAlertStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"critical\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Never\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"MinutesSinceLogBackup\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":120,\"palette\":\"greenRed\"}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"DatabaseName\",\"label\":\"Database\"},{\"columnId\":\"RecoveryModel\",\"label\":\"Recovery Model\"},{\"columnId\":\"LastFullBackupTime\",\"label\":\"Last Full Backup\"},{\"columnId\":\"HoursSinceFullBackup\",\"label\":\"Hours Since Full\"},{\"columnId\":\"FullBackupAlertStatus\",\"label\":\"Alert Status\"},{\"columnId\":\"LastLogBackupTime\",\"label\":\"Last Log Backup\"},{\"columnId\":\"MinutesSinceLogBackup\",\"label\":\"Min Since Log\"}]}},\"name\":\"grid-backup-alerts\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Full Backup Details\"},\"name\":\"full-backup-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let _db = dynamic([{DatabaseName}]);\\nSQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where array_length(_db) == 0 or '*' in (_db) or DatabaseName in (_db)\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| project SqlInstance, DatabaseName, RecoveryModel, LastFullBackupTime, HoursSinceFullBackup, LastFullBackupStatus, FullBackupAlertStatus\\n| order by SqlInstance asc, DatabaseName asc\",\"size\":0,\"title\":\"All Database Backup Status\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HoursSinceFullBackup\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":168,\"palette\":\"greenRed\"}},{\"columnMatch\":\"LastFullBackupStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"OK\",\"representation\":\"green\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"orange\",\"text\":\"{0}{1}\"}]}},{\"columnMatch\":\"FullBackupAlertStatus\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"OK\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Warning\",\"representation\":\"2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Critical\",\"representation\":\"critical\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Never\",\"representation\":\"unknown\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}]}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"DatabaseName\",\"label\":\"Database\"},{\"columnId\":\"RecoveryModel\",\"label\":\"Recovery Model\"},{\"columnId\":\"LastFullBackupTime\",\"label\":\"Last Full Backup\"},{\"columnId\":\"HoursSinceFullBackup\",\"label\":\"Hours Since Backup\"},{\"columnId\":\"LastFullBackupStatus\",\"label\":\"Backup Status\"},{\"columnId\":\"FullBackupAlertStatus\",\"label\":\"Alert Status\"}]}},\"name\":\"grid-full-backup\"},{\"type\":1,\"content\":{\"json\":\"---\\n## Log Backup Details (FULL Recovery Model)\"},\"name\":\"log-backup-header\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let _db = dynamic([{DatabaseName}]);\\nSQLServerMonitoring_CL\\n| where TimeGenerated {TimeRange}\\n| where '*' in ({SqlInstance}) or SqlInstance in ({SqlInstance})\\n| where array_length(_db) == 0 or '*' in (_db) or DatabaseName in (_db)\\n| where isnotempty(DatabaseName) and DatabaseName != \\\"_ERROR\\\"\\n| where RecoveryModel == \\\"FULL\\\"\\n| summarize arg_max(TimeGenerated, *) by SqlInstance, DatabaseName\\n| project SqlInstance, DatabaseName, LastLogBackupTime, MinutesSinceLogBackup\\n| order by MinutesSinceLogBackup desc\",\"size\":0,\"title\":\"Log Backup Status (Databases with FULL Recovery)\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{Workspace}\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"MinutesSinceLogBackup\",\"formatter\":8,\"formatOptions\":{\"min\":0,\"max\":120,\"palette\":\"greenRed\"}}],\"filter\":true,\"labelSettings\":[{\"columnId\":\"SqlInstance\",\"label\":\"SQL Instance\"},{\"columnId\":\"DatabaseName\",\"label\":\"Database\"},{\"columnId\":\"LastLogBackupTime\",\"label\":\"Last Log Backup\"},{\"columnId\":\"MinutesSinceLogBackup\",\"label\":\"Minutes Since Log Backup\"}]}},\"name\":\"grid-log-backup\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Backups\"},\"name\":\"group-backups\"}],\"fallbackResourceIds\":[],\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2023-06-01",
      "name": "[variables('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[variables('workbookContent')]",
        "version": "1.0",
        "sourceId": "Azure Monitor",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[variables('workbookId')]"
    },
    "workbookDisplayName": {
      "type": "string",
      "value": "[parameters('workbookDisplayName')]"
    }
  }
}